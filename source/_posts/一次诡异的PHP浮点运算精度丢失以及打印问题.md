---
title: 一次诡异的PHP浮点运算精度丢失以及打印问题
date: 2023-05-31 15:46:51
tags: ["PHP"]
categories: ["技术"]
---

项目开发时发现几个小数组成的数组进行求和的结果不对，第一反应就觉得是精度问题，于是做了实验：

```php
$array = [0.4, 0.4, 0.2, 0.4, 0.4, 0.2];
$arraySum = array_sum($array);
var_dump($arraySum);
var_dump(intval($arraySum));
var_export($arraySum);
```

猜猜以上代码运行的结果是什么？
<!-- more -->
三次打印结果如下：

```
float(2)
int(1)
1.9999999999999998
```

在进行小数运算时，切记不能简单粗暴的直接相加了，可以使用`bcadd`、`bcsub`这些函数来计算，比较两个浮点数是否相等可以使用`bccomp`函数，关于浮点数的精度，PHP官方文档中做了详细的说明：

> 浮点数的精度有限。尽管取决于系统，PHP 通常使用 IEEE 754 双精度格式，则由于取整而导致的最大相对误差为 1.11e-16。非基本数学运算可能会给出更大误差，并且要考虑到进行复合运算时的误差传递。
>
> 此外，以十进制能够精确表示的有理数如 0.1 或 0.7，无论有多少尾数都不能被内部所使用的二进制精确表示，因此不能在不丢失一点点精度的情况下转换为二进制的格式。这就会造成混乱的结果：例如，floor((0.1+0.7)*10) 通常会返回 7 而不是预期中的 8，因为该结果内部的表示其实是类似 7.9999999999999991118...。
> 
> 所以永远不要相信浮点数结果精确到了最后一位，也永远不要比较两个浮点数是否相等。如果确实需要更高的精度，应该使用[任意精度数学函数](https://www.php.net/manual/zh/ref.bc.php)或者[gmp函数](https://www.php.net/manual/zh/ref.gmp.php)。
> 
> 参见[» 浮点数指南](http://floating-point-gui.de/)网页的简单解释。
